\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{correction}

\RequirePackage{xkeyval}
% \RequirePackage{listings,plistings,xcolor} % for platex
\RequirePackage{listings,xcolor} % for lualatex
\RequirePackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{arrows.meta}

\tikzset{corblock/.style={
    rectangle,
    draw=black,
    rounded corners}}

% http://d.hatena.ne.jp/zrbabbler/20130302/1362228901
\RequirePackage{pxpgfmark} % remember picture を可能にする

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \makecomment コマンドの定義
% xkeyval.sty を使ってキーワード引数を処理
\makeatletter
% 2つ目のオプション引数は，\cor@saveなどとも関係してくるので注意
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{backgroundcolor}[red!30]{}
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{arrowcolor}[red]{}
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{shift}[(0,0)]{}
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{xshift}[0]{}
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{yshift}[0]{}
\define@cmdkey[correction]{mkcom}[cor@mkcom@]{width}[0.3\textwidth]{}
\presetkeys[correction]{mkcom}{backgroundcolor,arrowcolor,shift,xshift,yshift,width}{}

% 基本的には\letと同じ．
% ただし，control sequenceを直接指定するのではなく，\csnameのように文字列で指定する
\newcommand{\cor@let}[2]{%
  \edef\cor@tmp{\unexpanded\expandafter{\csname #1\endcsname}}%
  \expandafter\expandafter\expandafter\let\expandafter\cor@tmp\csname #2\endcsname%
}

% キーワード引数を保存・呼び出しする
\newcommand{\cor@save}[3]{\cor@let{cor@#1@#2@#3}{cor@#1@#2}}
\newcommand{\cor@load}[3]{\csname cor@#1@#2@#3\endcsname}

\newcommand{\makecomment}[3][]{
  % キーワード引数の処理
  \setkeys[correction]{mkcom}{#1}
  % キーワード引数を\usecommentから呼び出すために保存
  \cor@save{mkcom}{backgroundcolor}{#2}
  \cor@save{mkcom}{arrowcolor}{#2}
  \cor@save{mkcom}{shift}{#2}
  \cor@save{mkcom}{xshift}{#2}
  \cor@save{mkcom}{yshift}{#2}
  \cor@save{mkcom}{width}{#2}
  % \usecommentで呼び出す処理
  \expandafter\newcommand\csname commentname@#2\endcsname{%
    \begin{tikzpicture}[remember picture, overlay]
      \coordinate (X) at (0,3pt);
      % 予めletしないとうまくいかなかった．座標の足し算のところに直接書くと何故かエラー
      \path let \p1=\cor@load{mkcom}{shift}{#2},
                \p2=(\cor@load{mkcom}{xshift}{#2},\cor@load{mkcom}{yshift}{#2}) in
      node[corblock,
           fill=\cor@load{mkcom}{backgroundcolor}{#2},
           anchor=east,
           text width=\cor@load{mkcom}{width}{#2}]
        (comment) at ($(current page.east |- X) + (-10pt,0) + (\p1) + (\p2)$)  {#3};
      \draw[color=\cor@load{mkcom}{arrowcolor}{#2},
            -{Latex[length=3mm,width=2mm]}]
        (comment) -- (X);
    \end{tikzpicture}}
}
\newcommand{\usecomment}[1]{\csname commentname@#1\endcsname}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% listingsの設定
\definecolor{OliveGreen}{cmyk}{0.64,0,0.95,0.40}
\definecolor{colFunc}{rgb}{1,0.07,0.54}
\definecolor{CadetBlue}{cmyk}{0.62,0.57,0.23,0}
\definecolor{Brown}{cmyk}{0,0.81,1,0.60}
\definecolor{colID}{rgb}{0.63,0.44,0}

\lstset{
  language=[LaTeX]TeX,
  basicstyle={\ttfamily\small},
  keywordstyle={\color{OliveGreen}},
  keywordstyle={[2]\color{colFunc}},
  keywordstyle={[3]\color{CadetBlue}},
  commentstyle={\color{Brown}},
  % identifierstyle={\color{colID}},
  stringstyle=\color{blue},
  tabsize=2,
  frame=single,
  numbers=left,
  numberstyle={\ttfamily\small},
  breaklines=true,
  % backgroundcolor={\color[gray]{.95}}, % backgroundcolorがあると，yshiftを負にしたときに矢印が隠れてしまう
  captionpos=b,
  linewidth=0.8\textwidth
}
